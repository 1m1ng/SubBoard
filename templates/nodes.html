{% extends "base.html" %}

{% block title %}节点信息 - SubBoard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='nodes.css') }}">
{% endblock %}

{% block content %}
<div class="nodes-container">
    <div class="nodes-header">
        <h2>节点信息</h2>
        {% if is_admin %}
            <span class="badge badge-admin">管理员视图 - 所有节点</span>
        {% endif %}
        <button id="refreshBtn" class="btn btn-primary">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
            刷新
        </button>
    </div>

    <!-- 套餐信息提示（普通用户） -->
    {% if not is_admin %}
    <div id="packageInfo" class="package-info-banner" style="display: none;">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <span id="packageInfoText">显示您的套餐节点</span>
    </div>
    {% endif %}

    <!-- 加载提示 -->
    <div id="loadingIndicator" class="loading-indicator">
        <div class="spinner"></div>
        <p>正在加载节点信息...</p>
    </div>

    <!-- 错误提示 -->
    <div id="errorMessage" class="error-message" style="display: none;">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <span id="errorText">加载失败</span>
    </div>

    <!-- 节点列表 -->
    <div id="nodesGrid" class="nodes-grid"></div>
</div>

<script>
let isLoading = false;

// 格式化字节数
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
}

// 计算使用百分比
function calculatePercentage(used, total) {
    if (total === 0) return 0; // 无限流量
    return Math.min((used / total) * 100, 100);
}

// 创建节点卡片
function createNodeCard(inbound) {
    const card = document.createElement('div');
    card.className = 'node-card';
    
    // 计算已用流量
    const used = (inbound.up || 0) + (inbound.down || 0);
    const total = inbound.total || 0;
    const percentage = calculatePercentage(used, total);
    
    // 状态徽章
    const statusBadge = inbound.enable 
        ? '<span class="status-badge status-active">可用</span>'
        : '<span class="status-badge status-inactive">不可用</span>';
    
    // 流量倍率标签（如果有）
    const trafficRateBadge = inbound.traffic_rate 
        ? `<span class="traffic-rate-badge" title="流量倍率">×${inbound.traffic_rate}</span>`
        : '';
    
    // 流量信息
    let trafficInfo = '';
    if (total === 0) {
        trafficInfo = `
            <div class="traffic-info">
                <div class="traffic-label">流量使用情况</div>
                <div class="traffic-unlimited">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
                        <line x1="12" y1="2" x2="12" y2="12"></line>
                    </svg>
                    <span>无限流量</span>
                </div>
                <div class="traffic-details">
                    <div class="traffic-item">
                        <span class="traffic-item-label">上传:</span>
                        <span class="traffic-item-value">${formatBytes(inbound.up || 0)}</span>
                    </div>
                    <div class="traffic-item">
                        <span class="traffic-item-label">下载:</span>
                        <span class="traffic-item-value">${formatBytes(inbound.down || 0)}</span>
                    </div>
                </div>
            </div>
        `;
    } else {
        trafficInfo = `
            <div class="traffic-info">
                <div class="traffic-label">流量使用情况</div>
                <div class="traffic-stats">
                    <span class="traffic-used">${formatBytes(used)}</span>
                    <span class="traffic-separator">/</span>
                    <span class="traffic-total">${formatBytes(total)}</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${percentage}%"></div>
                </div>
                <div class="traffic-percentage">${percentage.toFixed(1)}% 已使用</div>
                <div class="traffic-details">
                    <div class="traffic-item">
                        <span class="traffic-item-label">上传:</span>
                        <span class="traffic-item-value">${formatBytes(inbound.up || 0)}</span>
                    </div>
                    <div class="traffic-item">
                        <span class="traffic-item-label">下载:</span>
                        <span class="traffic-item-value">${formatBytes(inbound.down || 0)}</span>
                    </div>
                </div>
            </div>
        `;
    }
    
    // 节点名称，如果为空显示服务器信息
    const nodeName = inbound.remark || `${inbound.server}:${inbound.port}`;
    
    card.innerHTML = `
        <div class="node-header">
            <div class="node-title-section">
                <h3 class="node-name">${nodeName}</h3>
                <div class="node-badges">
                    ${statusBadge}
                    ${trafficRateBadge}
                </div>
            </div>
        </div>
        <div class="node-info">
            <div class="node-info-item">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                    <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                    <line x1="6" y1="6" x2="6.01" y2="6"></line>
                    <line x1="6" y1="18" x2="6.01" y2="18"></line>
                </svg>
                <span>${inbound.board_name || inbound.server}</span>
            </div>
            <div class="node-info-item">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="2" y1="12" x2="22" y2="12"></line>
                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                </svg>
                <span>${inbound.protocol || 'N/A'}</span>
            </div>
            <div class="node-info-item">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                </svg>
                <span>端口 ${inbound.port}</span>
            </div>
        </div>
        ${trafficInfo}
    `;
    
    return card;
}

// 加载节点信息
async function loadNodes() {
    if (isLoading) return;
    
    isLoading = true;
    const loadingIndicator = document.getElementById('loadingIndicator');
    const errorMessage = document.getElementById('errorMessage');
    const nodesGrid = document.getElementById('nodesGrid');
    const refreshBtn = document.getElementById('refreshBtn');
    
    loadingIndicator.style.display = 'block';
    errorMessage.style.display = 'none';
    nodesGrid.innerHTML = '';
    refreshBtn.disabled = true;
    
    try {
        const response = await fetch('/api/inbounds');
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || '加载失败');
        }
        
        loadingIndicator.style.display = 'none';
        
        // 显示套餐信息（普通用户）
        if (data.package_name) {
            const packageInfo = document.getElementById('packageInfo');
            const packageInfoText = document.getElementById('packageInfoText');
            if (packageInfo && packageInfoText) {
                packageInfoText.textContent = `当前套餐: ${data.package_name} | 共 ${data.inbounds.length} 个节点`;
                packageInfo.style.display = 'flex';
            }
        }
        
        if (data.inbounds && data.inbounds.length > 0) {
            // 先清空网格，然后添加新卡片以触发动画
            nodesGrid.style.opacity = '0';
            setTimeout(() => {
                data.inbounds.forEach(inbound => {
                    const card = createNodeCard(inbound);
                    nodesGrid.appendChild(card);
                });
                nodesGrid.style.opacity = '1';
            }, 50);
        } else {
            const message = data.message || '暂无节点信息';
            nodesGrid.innerHTML = `<div class="no-data">${message}</div>`;
        }
    } catch (error) {
        console.error('加载节点失败:', error);
        loadingIndicator.style.display = 'none';
        errorMessage.style.display = 'flex';
        document.getElementById('errorText').textContent = error.message || '加载节点信息失败';
    } finally {
        isLoading = false;
        refreshBtn.disabled = false;
    }
}

// 刷新按钮点击事件
document.getElementById('refreshBtn').addEventListener('click', () => {
    loadNodes();
});

// 页面加载时自动加载节点
document.addEventListener('DOMContentLoaded', () => {
    loadNodes();
});
</script>
{% endblock %}
