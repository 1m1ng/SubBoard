{% extends "base.html" %}

{% block title %}Mihomo æ¨¡æ¿ç®¡ç† - SubBoard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='mihomo.css') }}">
{% endblock %}

{% block content %}
<div class="admin-container">
    <h2>âš™ï¸ Mihomo é…ç½®æ¨¡æ¿ç®¡ç†</h2>
    
    <!-- æ¨¡æ¿ç¼–è¾‘å™¨ -->
    <div class="admin-section">
        <h3>ğŸ“ ç¼–è¾‘æ¨¡æ¿</h3>
        <form method="POST" action="{{ url_for('mihomo.save_mihomo_template') }}" id="templateForm">
            <div class="form-group">
                <label for="name">æ¨¡æ¿åç§°</label>
                <input type="text" id="name" name="name" 
                       value="{% if active_template %}{{ active_template.name }}{% else %}é»˜è®¤æ¨¡æ¿{% endif %}" 
                       required>
            </div>
            
            <div class="form-group">
                <label for="template_content">
                    æ¨¡æ¿å†…å®¹ (YAML æ ¼å¼)
                    <small>è¯·ç¡®ä¿ YAML æ ¼å¼æ­£ç¡®ï¼Œproxies å­—æ®µä¼šè‡ªåŠ¨è¢«æ›¿æ¢ä¸ºè®¢é˜…èŠ‚ç‚¹</small>
                </label>
                <div class="yaml-editor-wrapper">
                    <textarea id="template_content" name="template_content" 
                              rows="25" class="yaml-editor" 
                              spellcheck="false">{% if active_template %}{{ active_template.template_content }}{% else %}mode: rule
socks-port: 1080
tproxy-port: 1536
mixed-port: 7890
redir-port: 7891
ipv6: true
allow-lan: true
unified-delay: true
tcp-concurrent: true

find-process-mode: strict
global-client-fingerprint: chrome

profile:
  store-selected: true
  store-fake-ip: true

keep-alive-idle: 600
keep-alive-interval: 30

dns:
  enable: true
  ipv6: true
  listen: 0.0.0.0:1053
  enhanced-mode: fake-ip
  fake-ip-range: 28.0.0.1/8
  default-nameserver:
    - 223.5.5.5
  nameserver:
    - https://223.5.5.5/dns-query
    - https://120.53.53.53/dns-query

proxy-groups:
  - {name: Proxy, type: select, proxies: [Auto], include-all-proxies: true}
  - {name: Auto, type: url-test, include-all-proxies: true}

rules:
  - MATCH,Proxy
{% endif %}</textarea>
                </div>
                <div class="editor-actions">
                    <button type="button" class="btn-small btn-secondary" onclick="formatYAML()">
                        ğŸ“ æ ¼å¼åŒ–
                    </button>
                    <button type="button" class="btn-small btn-secondary" onclick="validateYAML()">
                        âœ“ éªŒè¯ YAML
                    </button>
                </div>
            </div>
            
            <div class="checkbox-group">
                <label>
                    <input type="hidden" name="set_active" value="false">
                    <input type="checkbox" name="set_active" value="true" 
                           {% if active_template %}checked{% endif %} 
                           onchange="this.previousElementSibling.disabled = this.checked;">
                    <span>è®¾ç½®ä¸ºæ´»åŠ¨æ¨¡æ¿</span>
                </label>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-success">ğŸ’¾ ä¿å­˜æ¨¡æ¿</button>
            </div>
        </form>
    </div>
    
    <!-- æ¨¡æ¿åˆ—è¡¨ -->
    <div class="admin-section">
        <h3>ğŸ“‹ å·²ä¿å­˜çš„æ¨¡æ¿</h3>
        
        {% if templates %}
        <div class="table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>åç§°</th>
                        <th>çŠ¶æ€</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æ›´æ–°æ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for template in templates %}
                    <tr>
                        <td><strong>{{ template.name }}</strong></td>
                        <td>
                            {% if template.is_active %}
                                <span class="badge badge-admin">âœ“ æ´»åŠ¨</span>
                            {% else %}
                                <span class="badge badge-user">å¾…æ¿€æ´»</span>
                            {% endif %}
                        </td>
                        <td>{{ template.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>{{ template.updated_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <div class="actions">
                                {% if not template.is_active %}
                                <button class="btn-small btn-primary" 
                                        onclick="if(confirm('ç¡®å®šè¦æ¿€æ´»æ¨¡æ¿ {{ template.name }} å—ï¼Ÿ')) { window.location.href='{{ url_for('mihomo.set_active_template', template_id=template.id) }}'; }">
                                    æ¿€æ´»
                                </button>
                                {% endif %}
                                <button class="btn-small btn-primary" 
                                        onclick="loadTemplate({{ template.id }}, '{{ template.name }}', `{{ template.template_content | replace('`', '\\`') }}`)">
                                    ç¼–è¾‘
                                </button>
                                <button class="btn-small btn-danger" 
                                        onclick="if(confirm('ç¡®å®šè¦åˆ é™¤æ¨¡æ¿ {{ template.name }} å—ï¼Ÿ')) { window.location.href='{{ url_for('mihomo.delete_mihomo_template', template_id=template.id) }}'; }">
                                    åˆ é™¤
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="no-data">æš‚æ— ä¿å­˜çš„æ¨¡æ¿</p>
        {% endif %}
    </div>
    
    <!-- ä½¿ç”¨è¯´æ˜ -->
    <div class="admin-section">
        <h3>ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
        <div class="info-box">
            <h4>1. æ¨¡æ¿è¯´æ˜</h4>
            <p>Mihomo é…ç½®æ¨¡æ¿ç”¨äºå°†è®¢é˜…é“¾æ¥è½¬æ¢ä¸º Mihomo å†…æ ¸å¯è¯»çš„ YAML é…ç½®æ–‡ä»¶ã€‚</p>
            
            <h4>2. è‡ªåŠ¨æ›¿æ¢</h4>
            <p><code>proxies</code> å­—æ®µä¼šè‡ªåŠ¨è¢«æ›¿æ¢ä¸ºä»è®¢é˜…é“¾æ¥è§£æå‡ºçš„èŠ‚ç‚¹åˆ—è¡¨ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®ã€‚</p>
            
            <h4>3. å®¢æˆ·ç«¯è¯†åˆ«</h4>
            <p>å½“è®¢é˜…é“¾æ¥çš„ User-Agent åŒ…å« <code>clash</code> æˆ– <code>Mihomo</code> æ—¶ï¼Œä¼šè‡ªåŠ¨è¿”å› YAML æ ¼å¼é…ç½®ï¼›å¦åˆ™è¿”å›æ ‡å‡† Base64 æ ¼å¼ã€‚</p>
            
            <h4>4. é…ç½®ç¤ºä¾‹</h4>
            <p>æ¨¡æ¿åº”åŒ…å«åŸºæœ¬çš„ Mihomo é…ç½®é¡¹ï¼Œå¦‚ modeã€portã€dnsã€proxy-groupsã€rules ç­‰ã€‚</p>
            
            <h4>5. æ³¨æ„äº‹é¡¹</h4>
            <ul>
                <li>ä¿å­˜å‰è¯·ç¡®ä¿ YAML æ ¼å¼æ­£ç¡®</li>
                <li>åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨æ¨¡æ¿</li>
                <li>proxy-groups ä¸­ä½¿ç”¨ <code>include-all-proxies: true</code> å¯è‡ªåŠ¨åŒ…å«æ‰€æœ‰èŠ‚ç‚¹</li>
            </ul>
        </div>
    </div>
</div>

<script>
// åŠ è½½æ¨¡æ¿åˆ°ç¼–è¾‘å™¨
function loadTemplate(id, name, content) {
    document.getElementById('name').value = name;
    document.getElementById('template_content').value = content;
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// éªŒè¯ YAML
function validateYAML() {
    const content = document.getElementById('template_content').value;
    
    fetch('/mihomo_template/validate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
        if (data.valid) {
            alert('âœ“ YAML æ ¼å¼æ­£ç¡®ï¼');
        } else {
            alert('âœ— YAML æ ¼å¼é”™è¯¯:\n' + data.error);
        }
    })
    .catch(error => {
        alert('éªŒè¯å¤±è´¥: ' + error);
    });
}

// æ ¼å¼åŒ– YAMLï¼ˆç®€å•çš„ç¼©è¿›å¤„ç†ï¼‰
function formatYAML() {
    const textarea = document.getElementById('template_content');
    const content = textarea.value;
    
    // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„æ ¼å¼åŒ–é€»è¾‘
    // ç›®å‰åªæ˜¯ç®€å•çš„æç¤º
    alert('YAML æ ¼å¼åŒ–åŠŸèƒ½æç¤ºï¼š\n\n1. ç¡®ä¿ä½¿ç”¨ç©ºæ ¼ç¼©è¿›ï¼ˆé€šå¸¸æ˜¯2ä¸ªç©ºæ ¼ï¼‰\n2. åˆ—è¡¨é¡¹ä½¿ç”¨ "- " å¼€å¤´\n3. é”®å€¼å¯¹ä½¿ç”¨ ": " åˆ†éš”\n4. å¤šè¡Œå†…å®¹ä½¿ç”¨ | æˆ– >');
}

// è¡¨å•æäº¤å‰çš„é¢å¤–éªŒè¯
document.getElementById('templateForm').addEventListener('submit', function(e) {
    const content = document.getElementById('template_content').value.trim();
    
    if (!content) {
        e.preventDefault();
        alert('æ¨¡æ¿å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');
        return false;
    }
    
    // ç®€å•çš„ YAML è¯­æ³•æ£€æŸ¥
    const lines = content.split('\n');
    let hasError = false;
    let errorMessage = '';
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº† tabï¼ˆYAML ä¸å…è®¸ tabï¼‰
        if (line.includes('\t')) {
            hasError = true;
            errorMessage = `ç¬¬ ${i + 1} è¡ŒåŒ…å« Tab å­—ç¬¦ï¼ŒYAML ä¸å…è®¸ä½¿ç”¨ Tab ç¼©è¿›ï¼Œè¯·ä½¿ç”¨ç©ºæ ¼`;
            break;
        }
    }
    
    if (hasError) {
        e.preventDefault();
        alert('YAML æ ¼å¼é”™è¯¯:\n' + errorMessage);
        return false;
    }
});
</script>
{% endblock %}
