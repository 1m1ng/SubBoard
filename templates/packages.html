{% extends "base.html" %}

{% block title %}套餐管理 - SubBoard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/packages.css') }}">
{% endblock %}

{% block content %}
<div class="admin-container">
    <h2>流量套餐管理</h2>
    
    <!-- 创建套餐表单 -->
    <div class="admin-section">
        <h3>创建新套餐</h3>
        <form method="POST" action="{{ url_for('packages.create_package') }}" class="admin-form" id="createPackageForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="name">套餐名称</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="total_traffic">总流量 (GB)</label>
                    <input type="number" id="total_traffic" name="total_traffic" required min="1" step="1">
                </div>
            </div>
            
            <div class="form-group">
                <div class="label-with-button">
                    <label>可用节点</label>
                    <button type="button" class="btn-refresh" onclick="refreshAllNodes('create')" title="刷新所有节点">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <polyline points="1 20 1 14 7 14"></polyline>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                        刷新
                    </button>
                </div>
                <div class="nodes-selection">
                    {% for server in servers %}
                    <div class="server-group">
                        <div class="server-header" onclick="toggleServerNodes('create', '{{ server.board_name }}')">
                            <span class="server-name">📡 {{ server.board_name }}</span>
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="nodes-list" id="create_nodes_{{ server.board_name }}" style="display: none;">
                            <div class="loading-text">加载中...</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">创建套餐</button>
        </form>
    </div>

    <!-- 套餐列表 -->
    <div class="admin-section">
        <h3>套餐列表 ({{ packages|length }} 个套餐)</h3>
        {% if packages %}
        <div class="table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>套餐名称</th>
                        <th>总流量</th>
                        <th>可用节点数</th>
                        <th>使用用户数</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for package in packages %}
                    <tr>
                        <td>{{ package.id }}</td>
                        <td>{{ package.name }}</td>
                        <td>{{ (package.total_traffic / 1024 / 1024 / 1024) | round(2) }} GB</td>
                        <td>{{ package.nodes|length }}</td>
                        <td>{{ package.users_count }}</td>
                        <td>{{ package.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <button class="btn-small btn-primary" onclick='editPackage({{ package.id }}, "{{ package.name }}", {{ (package.total_traffic / 1024 / 1024 / 1024) | round(2) }}, {{ package.nodes | tojson }})'>编辑</button>
                            <button class="btn-small btn-danger" onclick="if(confirm('确定要删除套餐 {{ package.name }} 吗？')) { window.location.href='{{ url_for('packages.delete_package', package_id=package.id) }}'; }">删除</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="no-data">暂无套餐</p>
        {% endif %}
    </div>
</div>

<!-- 编辑套餐模态框 -->
<div id="editPackageModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h3>编辑套餐</h3>
        <form id="editPackageForm" method="POST" action="">
            <div class="form-row">
                <div class="form-group">
                    <label for="edit_name">套餐名称</label>
                    <input type="text" id="edit_name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="edit_total_traffic">总流量 (GB)</label>
                    <input type="number" id="edit_total_traffic" name="total_traffic" required min="1" step="1">
                </div>
            </div>
            
            <div class="form-group">
                <div class="label-with-button">
                    <label>可用节点</label>
                    <button type="button" class="btn-refresh" onclick="refreshAllNodes('edit')" title="刷新所有节点">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <polyline points="1 20 1 14 7 14"></polyline>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                        刷新
                    </button>
                </div>
                <div class="nodes-selection">
                    {% for server in servers %}
                    <div class="server-group">
                        <div class="server-header" onclick="toggleServerNodes('edit', '{{ server.board_name }}')">
                            <span class="server-name">📡 {{ server.board_name }}</span>
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="nodes-list" id="edit_nodes_{{ server.board_name }}" style="display: none;">
                            <div class="loading-text">加载中...</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="submit" class="btn btn-primary">保存修改</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">取消</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// 注入服务器列表数据供JavaScript使用
window.serversData = {{ servers | map(attribute='board_name') | list | tojson }};
</script>
<script src="{{ url_for('static', filename='js/packages.js') }}"></script>
{% endblock %}
