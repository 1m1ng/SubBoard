{% extends "base.html" %}

{% block title %}å¥—é¤ç®¡ç† - SubBoard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='packages.css') }}">
{% endblock %}

{% block content %}
<div class="admin-container">
    <h2>æµé‡å¥—é¤ç®¡ç†</h2>
    
    <!-- åˆ›å»ºå¥—é¤è¡¨å• -->
    <div class="admin-section">
        <h3>åˆ›å»ºæ–°å¥—é¤</h3>
        <form method="POST" action="{{ url_for('packages.create_package') }}" class="admin-form" id="createPackageForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="name">å¥—é¤åç§°</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="total_traffic">æ€»æµé‡ (GB)</label>
                    <input type="number" id="total_traffic" name="total_traffic" required min="1" step="1">
                </div>
            </div>
            
            <div class="form-group">
                <div class="label-with-button">
                    <label>å¯ç”¨èŠ‚ç‚¹</label>
                    <button type="button" class="btn-refresh" onclick="refreshAllNodes('create')" title="åˆ·æ–°æ‰€æœ‰èŠ‚ç‚¹">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <polyline points="1 20 1 14 7 14"></polyline>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                        åˆ·æ–°
                    </button>
                </div>
                <div class="nodes-selection">
                    {% for server in servers %}
                    <div class="server-group">
                        <div class="server-header" onclick="toggleServerNodes('create', '{{ server.board_name }}')">
                            <span class="server-name">ğŸ“¡ {{ server.board_name }}</span>
                            <span class="toggle-icon">â–¼</span>
                        </div>
                        <div class="nodes-list" id="create_nodes_{{ server.board_name }}" style="display: none;">
                            <div class="loading-text">åŠ è½½ä¸­...</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">åˆ›å»ºå¥—é¤</button>
        </form>
    </div>

    <!-- å¥—é¤åˆ—è¡¨ -->
    <div class="admin-section">
        <h3>å¥—é¤åˆ—è¡¨ ({{ packages|length }} ä¸ªå¥—é¤)</h3>
        {% if packages %}
        <div class="table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>å¥—é¤åç§°</th>
                        <th>æ€»æµé‡</th>
                        <th>å¯ç”¨èŠ‚ç‚¹æ•°</th>
                        <th>ä½¿ç”¨ç”¨æˆ·æ•°</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for package in packages %}
                    <tr>
                        <td>{{ package.id }}</td>
                        <td>{{ package.name }}</td>
                        <td>{{ (package.total_traffic / 1024 / 1024 / 1024) | round(2) }} GB</td>
                        <td>{{ package.nodes|length }}</td>
                        <td>{{ package.users_count }}</td>
                        <td>{{ package.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <button class="btn-small btn-primary" onclick='editPackage({{ package.id }}, "{{ package.name }}", {{ (package.total_traffic / 1024 / 1024 / 1024) | round(2) }}, {{ package.nodes | tojson }})'>ç¼–è¾‘</button>
                            <button class="btn-small btn-danger" onclick="if(confirm('ç¡®å®šè¦åˆ é™¤å¥—é¤ {{ package.name }} å—ï¼Ÿ')) { window.location.href='{{ url_for('packages.delete_package', package_id=package.id) }}'; }">åˆ é™¤</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="no-data">æš‚æ— å¥—é¤</p>
        {% endif %}
    </div>
</div>

<!-- ç¼–è¾‘å¥—é¤æ¨¡æ€æ¡† -->
<div id="editPackageModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h3>ç¼–è¾‘å¥—é¤</h3>
        <form id="editPackageForm" method="POST" action="">
            <div class="form-row">
                <div class="form-group">
                    <label for="edit_name">å¥—é¤åç§°</label>
                    <input type="text" id="edit_name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="edit_total_traffic">æ€»æµé‡ (GB)</label>
                    <input type="number" id="edit_total_traffic" name="total_traffic" required min="1" step="1">
                </div>
            </div>
            
            <div class="form-group">
                <div class="label-with-button">
                    <label>å¯ç”¨èŠ‚ç‚¹</label>
                    <button type="button" class="btn-refresh" onclick="refreshAllNodes('edit')" title="åˆ·æ–°æ‰€æœ‰èŠ‚ç‚¹">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <polyline points="1 20 1 14 7 14"></polyline>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                        åˆ·æ–°
                    </button>
                </div>
                <div class="nodes-selection">
                    {% for server in servers %}
                    <div class="server-group">
                        <div class="server-header" onclick="toggleServerNodes('edit', '{{ server.board_name }}')">
                            <span class="server-name">ğŸ“¡ {{ server.board_name }}</span>
                            <span class="toggle-icon">â–¼</span>
                        </div>
                        <div class="nodes-list" id="edit_nodes_{{ server.board_name }}" style="display: none;">
                            <div class="loading-text">åŠ è½½ä¸­...</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
            </div>
        </form>
    </div>
</div>

<script>
// å­˜å‚¨å·²åŠ è½½çš„èŠ‚ç‚¹æ•°æ®
const nodesCache = {};
const loadedServers = {};

// åˆ·æ–°æ‰€æœ‰èŠ‚ç‚¹ï¼ˆæ¸…é™¤ç¼“å­˜å¹¶é‡æ–°åŠ è½½ï¼‰
async function refreshAllNodes(formType) {
    const refreshBtn = event.target.closest('.btn-refresh');
    const originalHTML = refreshBtn.innerHTML;
    
    // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    refreshBtn.disabled = true;
    refreshBtn.innerHTML = `
        <svg class="icon spinning" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
        </svg>
        åˆ·æ–°ä¸­...
    `;
    
    try {
        // è°ƒç”¨åç«¯åˆ·æ–°æ¥å£
        const response = await fetch('/packages/refresh_nodes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // æ¸…é™¤æœ¬åœ°ç¼“å­˜
            Object.keys(nodesCache).forEach(key => delete nodesCache[key]);
            Object.keys(loadedServers).forEach(key => {
                if (key.startsWith(formType + '_')) {
                    delete loadedServers[key];
                }
            });
            
            // é‡æ–°åŠ è½½æ‰€æœ‰å·²å±•å¼€çš„èŠ‚ç‚¹
            const servers = {{ servers | map(attribute='board_name') | list | tojson }};
            for (const boardName of servers) {
                const nodesList = document.getElementById(`${formType}_nodes_${boardName}`);
                if (nodesList && nodesList.style.display !== 'none') {
                    await loadNodes(formType, boardName);
                    loadedServers[`${formType}_${boardName}`] = true;
                }
            }
        } else {
            alert('åˆ·æ–°å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        console.error('åˆ·æ–°èŠ‚ç‚¹å¤±è´¥:', error);
        alert('åˆ·æ–°å¤±è´¥: ' + error.message);
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = originalHTML;
    }
}

// åˆ‡æ¢æœåŠ¡å™¨èŠ‚ç‚¹æ˜¾ç¤º
async function toggleServerNodes(formType, boardName) {
    const nodesList = document.getElementById(`${formType}_nodes_${boardName}`);
    const serverGroup = nodesList.closest('.server-group');
    const toggleIcon = serverGroup.querySelector('.toggle-icon');
    
    if (nodesList.style.display === 'none') {
        nodesList.style.display = 'block';
        toggleIcon.textContent = 'â–²';
        
        // å¦‚æœè¿˜æ²¡æœ‰åŠ è½½è¿‡èŠ‚ç‚¹ï¼Œåˆ™åŠ è½½
        if (!loadedServers[`${formType}_${boardName}`]) {
            await loadNodes(formType, boardName);
            loadedServers[`${formType}_${boardName}`] = true;
        }
    } else {
        nodesList.style.display = 'none';
        toggleIcon.textContent = 'â–¼';
    }
}

// åŠ è½½èŠ‚ç‚¹åˆ—è¡¨
async function loadNodes(formType, boardName) {
    const nodesList = document.getElementById(`${formType}_nodes_${boardName}`);
    
    try {
        const response = await fetch(`/packages/get_nodes/${boardName}`);
        const data = await response.json();
        
        if (data.success && data.nodes && data.nodes.length > 0) {
            // ç¼“å­˜èŠ‚ç‚¹æ•°æ®
            if (!nodesCache[boardName]) {
                nodesCache[boardName] = data.nodes;
            }
            
            let html = '';
            data.nodes.forEach(node => {
                const nodeId = `${boardName}|${node.id}|${node.name}`;
                const rateInputId = `rate_${boardName}_${node.name}`.replace(/[^a-zA-Z0-9_]/g, '_');
                html += `
                    <div class="node-item">
                        <label class="node-checkbox">
                            <input type="checkbox" name="nodes[]" value="${nodeId}">
                            <span class="node-name">${node.name}</span>
                        </label>
                        <div class="rate-input">
                            <label>å€ç‡:</label>
                            <input type="number" name="rate_${boardName}_${node.name}" 
                                   id="${rateInputId}" value="1.0" min="0.1" step="0.1" 
                                   class="rate-field">
                        </div>
                    </div>
                `;
            });
            nodesList.innerHTML = html;
        } else {
            nodesList.innerHTML = '<div class="no-data">è¯¥æœåŠ¡å™¨æš‚æ— èŠ‚ç‚¹</div>';
        }
    } catch (error) {
        console.error('åŠ è½½èŠ‚ç‚¹å¤±è´¥:', error);
        nodesList.innerHTML = '<div class="error-text">åŠ è½½å¤±è´¥</div>';
    }
}

// ç¼–è¾‘å¥—é¤
async function editPackage(packageId, name, totalTraffic, nodes) {
    document.getElementById('edit_name').value = name;
    document.getElementById('edit_total_traffic').value = totalTraffic;
    document.getElementById('editPackageForm').action = `/packages/edit/${packageId}`;
    
    // é‡ç½®æ‰€æœ‰èŠ‚ç‚¹é€‰æ‹©
    const allCheckboxes = document.querySelectorAll('#editPackageModal input[name="nodes[]"]');
    allCheckboxes.forEach(cb => cb.checked = false);
    
    // é‡ç½®æ‰€æœ‰å€ç‡
    const allRates = document.querySelectorAll('#editPackageModal .rate-field');
    allRates.forEach(rate => rate.value = '1.0');
    
    // å±•å¼€å¹¶åŠ è½½æ‰€æœ‰æœåŠ¡å™¨çš„èŠ‚ç‚¹
    const servers = {{ servers | map(attribute='board_name') | list | tojson }};
    for (const boardName of servers) {
        const nodesList = document.getElementById(`edit_nodes_${boardName}`);
        const serverGroup = nodesList.closest('.server-group');
        const toggleIcon = serverGroup.querySelector('.toggle-icon');
        
        nodesList.style.display = 'block';
        toggleIcon.textContent = 'â–²';
        
        if (!loadedServers[`edit_${boardName}`]) {
            await loadNodes('edit', boardName);
            loadedServers[`edit_${boardName}`] = true;
        }
    }
    
    // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿DOMå·²æ›´æ–°
    setTimeout(() => {
        // è®¾ç½®å·²é€‰æ‹©çš„èŠ‚ç‚¹
        nodes.forEach(node => {
            // éå†æ‰€æœ‰å¤é€‰æ¡†ï¼Œé€šè¿‡ board_name å’Œ inbound_id æ¥åŒ¹é…
            const checkboxes = document.querySelectorAll(`#editPackageModal input[name="nodes[]"]`);
            checkboxes.forEach(checkbox => {
                const value = checkbox.value;
                const parts = value.split('|');
                if (parts.length === 3) {
                    const [boardName, inboundId, nodeName] = parts;
                    // ä½¿ç”¨ board_name å’Œ inbound_id åŒ¹é…ï¼ˆè¿™ä¸¤ä¸ªæ˜¯ç¨³å®šçš„æ ‡è¯†ï¼‰
                    if (boardName === node.board_name && parseInt(inboundId) === node.inbound_id) {
                        checkbox.checked = true;
                        
                        // è®¾ç½®å€ç‡ï¼ˆä½¿ç”¨å½“å‰checkboxå¯¹åº”çš„èŠ‚ç‚¹åç§°ï¼‰
                        const rateInputName = `rate_${boardName}_${nodeName}`;
                        const rateInput = document.querySelector(`#editPackageModal input[name="${rateInputName}"]`);
                        if (rateInput) {
                            rateInput.value = node.traffic_rate;
                        }
                    }
                }
            });
        });
    }, 100);
    
    document.getElementById('editPackageModal').style.display = 'block';
}

// å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
function closeEditModal() {
    document.getElementById('editPackageModal').style.display = 'none';
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
window.onclick = function(event) {
    const modal = document.getElementById('editPackageModal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}
</script>
{% endblock %}
