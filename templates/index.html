{% extends "base.html" %}

{% block title %}é¦–é¡µ - SubBoard{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"></path>
                <path d="M2 12h20"></path>
            </svg>
            æ¬¢è¿ï¼Œ{{ user.username }}ï¼
        </h1>
        <p class="welcome-subtitle">è®¢é˜…èŠ‚ç‚¹ç®¡ç†é¢æ¿</p>
        
        <!-- è®¢é˜…ç®¡ç†æŒ‰é’® -->
        {% if subscription_url %}
        <div class="subscription-actions">
            <button class="btn btn-success" onclick="copySubscription()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                å¤åˆ¶è®¢é˜…é“¾æ¥
            </button>
            <form method="POST" action="{{ url_for('refresh_token') }}" style="display: inline;" 
                  onsubmit="return confirm('åˆ·æ–°Tokenåï¼Œæ—§çš„è®¢é˜…é“¾æ¥å°†å¤±æ•ˆã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ');">
                <button type="submit" class="btn btn-warning">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <polyline points="1 20 1 14 7 14"></polyline>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                    åˆ·æ–°è®¢é˜…Token
                </button>
            </form>
        </div>
        <input type="hidden" id="subscription_url" value="{{ subscription_url }}">
        {% endif %}
    </div>

    {% if user.email %}
        {% if nodes %}
            <div class="nodes-section">
                <h2 class="section-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                        <line x1="8" y1="21" x2="16" y2="21"></line>
                        <line x1="12" y1="17" x2="12" y2="21"></line>
                    </svg>
                    æˆ‘çš„èŠ‚ç‚¹
                </h2>
                
                <div class="nodes-grid">
                    {% for node in nodes %}
                    <div class="node-card">
                        <div class="node-header">
                            <div class="node-icon node-flag">
                                {% if node.country_code %}
                                    <img src="https://flagcdn.com/w80/{{ node.country_code }}.png" 
                                         alt="{{ node.country_code }}" 
                                         class="flag-img"
                                         loading="lazy"
                                         onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%2250%22 font-size=%2260%22>ğŸŒ</text></svg>';">
                                {% else %}
                                    <span style="font-size: 28px;">ğŸŒ</span>
                                {% endif %}
                            </div>
                            <div class="node-info">
                                <h3 class="node-name">
                                    {% if node.node_name %}
                                        {{ node.node_name }}
                                    {% else %}
                                        {{ node.email }}
                                    {% endif %}
                                </h3>
                                <span class="node-server">{{ node.server }}</span>
                            </div>
                            <div class="node-status">
                                {% if node.enable %}
                                <span class="status-badge status-active">æ´»è·ƒ</span>
                                {% else %}
                                <span class="status-badge status-inactive">ç¦ç”¨</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="node-traffic">
                            <div class="traffic-info">
                                <span class="traffic-label">æµé‡ä½¿ç”¨</span>
                                {% set used = (node.up + node.down) %}
                                {% set total = node.total %}
                                {% set percentage = (used / total * 100) if total > 0 else 0 %}
                                <span class="traffic-value">
                                    {{ "%.2f"|format(used / 1024 / 1024 / 1024) }} GB / 
                                    {{ "%.2f"|format(total / 1024 / 1024 / 1024) }} GB
                                </span>
                            </div>
                            <div class="traffic-bar">
                                <div class="traffic-bar-fill" style="width: {{ percentage }}%; 
                                    {% if percentage < 50 %}background: #28a745;
                                    {% elif percentage < 80 %}background: #ffc107;
                                    {% else %}background: #dc3545;{% endif %}">
                                </div>
                            </div>
                            <div class="traffic-details">
                                <span class="traffic-item">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="19" x2="12" y2="5"></line>
                                        <polyline points="5 12 12 5 19 12"></polyline>
                                    </svg>
                                    ä¸Šä¼ : {{ "%.2f"|format(node.up / 1024 / 1024 / 1024) }} GB
                                </span>
                                <span class="traffic-item">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <polyline points="19 12 12 19 5 12"></polyline>
                                    </svg>
                                    ä¸‹è½½: {{ "%.2f"|format(node.down / 1024 / 1024 / 1024) }} GB
                                </span>
                            </div>
                        </div>
                        
                        <div class="node-expiry">
                            {% if node.expiryTime == 0 %}
                            <div class="expiry-info">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M12 6v6l4 2"></path>
                                </svg>
                                <span class="expiry-text">æ°¸ä¹…æœ‰æ•ˆ</span>
                            </div>
                            {% else %}
                            {% set expiry_date = (node.expiryTime / 1000) | int %}
                            {% set days_left = calculate_days_left(node.expiryTime) %}
                            <div class="expiry-info">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                                <span class="expiry-text">
                                    åˆ°æœŸæ—¶é—´: {{ expiry_date | timestamp_to_date }}
                                    {% if days_left > 0 %}
                                    <span class="days-left">(å‰©ä½™ {{ days_left }} å¤©)</span>
                                    {% else %}
                                    <span class="expired">(å·²è¿‡æœŸ)</span>
                                    {% endif %}
                                </span>
                            </div>
                            <div class="reset-info">
                                <small>æµé‡é‡ç½®: {{ calculate_next_reset_date(node.expiryTime) }}</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <div class="empty-state">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                <h3>æš‚æ— èŠ‚ç‚¹æ•°æ®</h3>
                <p>è¯·æ£€æŸ¥æ‚¨çš„é‚®ç®±é…ç½®æ˜¯å¦æ­£ç¡®ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜</p>
            </div>
        {% endif %}
    {% else %}
        <div class="setup-prompt">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
            <h3>è¯·é…ç½®é‚®ç®±åœ°å€</h3>
            <p>æ‚¨çš„è´¦æˆ·å°šæœªé…ç½®é‚®ç®±ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ·»åŠ é‚®ç®±ä»¥ä½¿ç”¨èŠ‚ç‚¹æœåŠ¡</p>
        </div>
    {% endif %}

    <div class="dashboard-actions">
        <a href="{{ url_for('profile') }}" class="btn btn-primary">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
            ä¸ªäººèµ„æ–™
        </a>
        <a href="{{ url_for('logout') }}" class="btn btn-secondary">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            ç™»å‡º
        </a>
    </div>
</div>

<script>
function copySubscription() {
    const url = document.getElementById('subscription_url').value;
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(() => {
            alert('è®¢é˜…é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        }).catch(err => {
            fallbackCopy(url);
        });
    } else {
        fallbackCopy(url);
    }
}

function fallbackCopy(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    document.body.appendChild(textArea);
    textArea.select();
    
    try {
        document.execCommand('copy');
        alert('è®¢é˜…é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
    } catch (err) {
        prompt('è¯·æ‰‹åŠ¨å¤åˆ¶è®¢é˜…é“¾æ¥ï¼š', text);
    }
    
    document.body.removeChild(textArea);
}
</script>
{% endblock %}
