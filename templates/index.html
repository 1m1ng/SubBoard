{% extends "base.html" %}

{% block title %}首页 - SubBoard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>
            欢迎，{{ user.username }}！
        </h1>
        <p class="welcome-subtitle">订阅节点管理面板</p>
    </div>

    <!-- 套餐信息卡片 -->

    {% if package %}
        {% if user.package_expire_time is not none and user.package_expire_time <= now %}
            <!-- 套餐已过期 -->
            <div class="package-info-card">
                <div class="no-package">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    <h3>套餐已过期</h3>
                    <p>您的套餐已过期，请联系管理员续费或更换套餐。</p>
                </div>
            </div>
        {% else %}
            <!-- 有套餐，未过期或永久套餐 -->
            <div class="package-info-card">
                <div class="package-header">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                        <line x1="7" y1="7" x2="7.01" y2="7"></line>
                    </svg>
                    <h2>{{ package.name }}</h2>
                </div>
                <div class="package-details">
                    <!-- 流量使用情况 -->
                    <div class="detail-item">
                        <div class="detail-label">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                                <polyline points="17 6 23 6 23 12"></polyline>
                            </svg>
                            流量使用
                        </div>
                        <!-- 修复 used_traffic 为 None 时的错误 -->
                        {% set used_traffic = used_traffic or 0 %}
                        <div class="traffic-info">
                            <div class="traffic-text">
                                <span class="used">{{ "%.2f"|format((used_traffic / (1024 ** 3))) }} GB</span>
                                <span class="separator">/</span>
                                {% set total_gb = package.total_traffic / (1024 ** 3) %}
                                <span class="total">{{ "%.2f"|format(total_gb) }} GB</span>
                            </div>
                            <div class="progress-bar">
                                {% set used = (used_traffic / (1024 ** 3)) %}
                                {% set total = total_gb %}
                                {% set percentage = (used / total * 100) if total > 0 else 0 %}
                                {% if percentage >= 90 %}
                                    {% set bar_class = "danger" %}
                                {% elif percentage >= 70 %}
                                    {% set bar_class = "warning" %}
                                {% else %}
                                    {% set bar_class = "normal" %}
                                {% endif %}
                                <div class="progress-fill {{ bar_class }}" style="width: {{ [percentage, 100]|min }}%"></div>
                            </div>
                            <div class="traffic-percentage">{{ "%.1f"|format(percentage) }}% 已使用</div>
                        </div>
                    </div>
                    <!-- 到期时间 -->
                    <div class="detail-item">
                        <div class="detail-label">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            到期时间
                        </div>
                        <div class="detail-value">
                            {% if user.package_expire_time %}
                                {{ user.package_expire_time.strftime('%Y年%m月%d日 %H:%M') }}
                            {% else %}
                                无限期
                            {% endif %}
                        </div>
                    </div>
                    <!-- 下次流量重置 -->
                    {% if user.next_reset_time %}
                    <div class="detail-item">
                        <div class="detail-label">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"></polyline>
                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                            </svg>
                            下次流量重置
                        </div>
                        <div class="detail-value">
                            {{ user.next_reset_time.strftime('%Y年%m月%d日 %H:%M') }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    {% else %}
        <div class="package-info-card">
            <div class="no-package">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                <h3>无流量套餐</h3>
                <p>您当前没有流量套餐，请联系管理员开通</p>
            </div>
        </div>
    {% endif %}

    <!-- 订阅管理按钮：允许无限期套餐（package_expire_time 为 None）时也显示按钮 -->
    {% if subscription_url and package and (user.package_expire_time is none or user.package_expire_time > now) %}
    <div class="subscription-actions">
        <button class="btn btn-success" onclick="copySubscription()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            复制订阅链接
        </button>
        <form method="POST" action="{{ url_for('main.refresh_token') }}" style="display: inline;" 
              onsubmit="return confirm('刷新Token后，旧的订阅链接将失效。确定要继续吗？');">
            <button type="submit" class="btn btn-warning">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
                刷新订阅Token
            </button>
        </form>
    </div>
    <input type="hidden" id="subscription_url" value="{{ subscription_url }}">
    {% endif %}

    {% if not user.email %}
        <div class="setup-prompt">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
            <h3>请配置邮箱地址</h3>
            <p>您的账户尚未配置邮箱，请联系管理员添加邮箱以使用节点服务</p>
        </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/index.js') }}"></script>
{% endblock %}
